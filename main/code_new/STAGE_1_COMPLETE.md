# é˜¶æ®µ 1 å®Œæˆæ€»ç»“ - memU å­˜å‚¨å±‚å®ç°

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. åˆ›å»º memory_store.py

**æ–‡ä»¶ä½ç½®**: `main/code_new/memory_store.py`

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… memU æœåŠ¡åˆå§‹åŒ–å’Œé…ç½®
- âœ… ç”¨æˆ·ç”»åƒå­˜å‚¨å’ŒåŠ è½½ï¼ˆä½¿ç”¨ document modalityï¼‰
- âœ… å¯¹è¯å†å²å­˜å‚¨å’ŒåŠ è½½ï¼ˆä½¿ç”¨ conversation modalityï¼‰
- âœ… è®°å¿†æ£€ç´¢åŠŸèƒ½ï¼ˆç”¨äºä¸ªæ€§åŒ–å›ç­”ï¼‰
- âœ… å¤šç”¨æˆ·æ”¯æŒï¼ˆé€šè¿‡ user_id éš”ç¦»ï¼‰
- âœ… æœ¬åœ°ç¼“å­˜ä½œä¸ºé™çº§æ–¹æ¡ˆ

**ä¸»è¦æ–¹æ³•**:
- `save_profile(user_id, profile)` - ä¿å­˜ç”»åƒåˆ° memU
- `load_profile(user_id)` - ä» memU åŠ è½½ç”»åƒ
- `append_message(user_id, role, content)` - è¿½åŠ å¯¹è¯æ¶ˆæ¯
- `load_conversation(user_id, limit)` - åŠ è½½å¯¹è¯å†å²
- `get_user_memory(user_id, query)` - æ£€ç´¢ç”¨æˆ·è®°å¿†

### 2. åˆ›å»ºæµ‹è¯•è„šæœ¬

**æ–‡ä»¶ä½ç½®**: `main/code_new/test_memory_store.py`

**æµ‹è¯•è¦†ç›–**:
- âœ… ç”»åƒå­˜å‚¨å’ŒåŠ è½½æµ‹è¯•
- âœ… å¯¹è¯å†å²å­˜å‚¨å’ŒåŠ è½½æµ‹è¯•
- âœ… å¤šç”¨æˆ·éš”ç¦»æµ‹è¯•
- âœ… è®°å¿†æ£€ç´¢æµ‹è¯•

### 3. æµ‹è¯•ç»“æœ

**æµ‹è¯•çŠ¶æ€**: âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡

**æµ‹è¯•è¯¦æƒ…**:
1. **ç”»åƒå­˜å‚¨å’ŒåŠ è½½**: âœ… æˆåŠŸ
   - å¯ä»¥ä¿å­˜ç”»åƒåˆ° memU å’Œæœ¬åœ°ç¼“å­˜
   - å¯ä»¥åŠ è½½ç”»åƒï¼ˆä¼˜å…ˆä» memUï¼Œå¤±è´¥æ—¶ä»æœ¬åœ°ç¼“å­˜ï¼‰

2. **å¯¹è¯å†å²å­˜å‚¨å’ŒåŠ è½½**: âœ… æˆåŠŸ
   - å¯ä»¥è¿½åŠ å¯¹è¯æ¶ˆæ¯
   - å¯ä»¥åŠ è½½å®Œæ•´å¯¹è¯å†å²

3. **å¤šç”¨æˆ·éš”ç¦»**: âœ… æˆåŠŸ
   - ä¸åŒç”¨æˆ·çš„æ•°æ®äº’ä¸å¹²æ‰°
   - æ•°æ®æ­£ç¡®éš”ç¦»

4. **è®°å¿†æ£€ç´¢**: âš ï¸ éƒ¨åˆ†åŠŸèƒ½
   - memU æ£€ç´¢åŠŸèƒ½å·²å®ç°
   - å½“å‰å¯èƒ½å› ä¸ºæ•°æ®é‡å°‘æˆ–éœ€è¦æ—¶é—´ç´¢å¼•ï¼Œæš‚æ—¶æœªè¿”å›ç»“æœ
   - æœ¬åœ°ç¼“å­˜æ­£å¸¸å·¥ä½œ

## ğŸ“ æ•°æ®å­˜å‚¨ç»“æ„

### memU å­˜å‚¨
- **ç”»åƒ**: ä½¿ç”¨ `memorize()` æ–¹æ³•ï¼Œmodality="document"
- **å¯¹è¯**: ä½¿ç”¨ `memorize()` æ–¹æ³•ï¼Œmodality="conversation"
- **ç”¨æˆ·éš”ç¦»**: é€šè¿‡ `user={"user_id": "xxx"}` å‚æ•°

### æœ¬åœ°ç¼“å­˜ï¼ˆé™çº§æ–¹æ¡ˆï¼‰
```
code_new/data/
â”œâ”€â”€ profiles/          # ç”¨æˆ·ç”»åƒç¼“å­˜
â”‚   â”œâ”€â”€ test_user_001.json
â”‚   â””â”€â”€ test_user_002.json
â””â”€â”€ conversations/     # å¯¹è¯å†å²ç¼“å­˜
    â”œâ”€â”€ test_user_001.json
    â””â”€â”€ test_user_002.json
```

## ğŸ”§ æŠ€æœ¯å®ç°

### memU æœåŠ¡é…ç½®

```python
service = MemoryService(
    llm_profiles={
        "default": {
            "base_url": "https://dashscope.aliyuncs.com/compatible-mode/v1",
            "api_key": dashscope_key,
            "chat_model": "qwen3-max",
            "client_backend": "sdk"
        },
        "embedding": {
            "base_url": "https://dashscope.aliyuncs.com/compatible-mode/v1",
            "api_key": dashscope_key,
            "embed_model": "text-embedding-v2",
            "client_backend": "sdk"
        }
    },
    database_config={
        "metadata_store": {"provider": "inmemory"},
    },
    retrieve_config={"method": "rag"},
)
```

### å­˜å‚¨ç­–ç•¥

1. **ç”»åƒå­˜å‚¨**:
   - å°†ç”»åƒè½¬æ¢ä¸º JSON å­—ç¬¦ä¸²
   - åˆ›å»ºä¸´æ—¶æ–‡ä»¶
   - ä½¿ç”¨ `memorize()` å­˜å‚¨ä¸º document
   - åŒæ—¶ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜

2. **å¯¹è¯å­˜å‚¨**:
   - å°†å¯¹è¯ç»„ç»‡æˆ conversation æ ¼å¼
   - åˆ›å»ºä¸´æ—¶æ–‡ä»¶
   - ä½¿ç”¨ `memorize()` å­˜å‚¨ä¸º conversation
   - åŒæ—¶ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜

3. **é™çº§æœºåˆ¶**:
   - memU è°ƒç”¨å¤±è´¥æ—¶è‡ªåŠ¨ä½¿ç”¨æœ¬åœ°ç¼“å­˜
   - ç¡®ä¿æ•°æ®ä¸ä¸¢å¤±

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **memU æ£€ç´¢å»¶è¿Ÿ**:
   - memU çš„æ£€ç´¢åŠŸèƒ½å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´æ‰èƒ½ç”Ÿæ•ˆ
   - æ–°å­˜å‚¨çš„æ•°æ®å¯èƒ½éœ€è¦ç­‰å¾…ç´¢å¼•å®Œæˆ
   - å½“å‰ä¸»è¦ä¾èµ–æœ¬åœ°ç¼“å­˜è¿›è¡Œæ•°æ®åŠ è½½

2. **ä¸´æ—¶æ–‡ä»¶ç®¡ç†**:
   - ä½¿ç”¨ä¸´æ—¶ç›®å½•å­˜å‚¨ä¸´æ—¶æ–‡ä»¶
   - ä¸´æ—¶æ–‡ä»¶åœ¨ç¨‹åºè¿è¡ŒæœŸé—´ä¿ç•™
   - å¯ä»¥è€ƒè™‘æ·»åŠ æ¸…ç†æœºåˆ¶

3. **å¼‚æ­¥æ“ä½œ**:
   - æ‰€æœ‰ memU æ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„
   - éœ€è¦ä½¿ç”¨ `await` å…³é”®å­—
   - æµ‹è¯•è„šæœ¬ä½¿ç”¨ `asyncio.run()`

## ğŸ¯ å®Œæˆæ ‡å‡†æ£€æŸ¥

- [x] å¯ä»¥ç‹¬ç«‹è¿è¡Œæµ‹è¯•è„šæœ¬å†™å…¥/è¯»å–æ•°æ® âœ…
- [x] é‡å¯ç¨‹åºåæˆåŠŸä»æœ¬åœ°ç¼“å­˜åŠ è½½å†å²æ•°æ® âœ…
- [x] å¤šç”¨æˆ·æ•°æ®äº’ä¸å¹²æ‰° âœ…
- [x] æ–‡ä»¶ä¸å­˜åœ¨æ—¶è‡ªåŠ¨åˆ›å»ºç©ºç»“æ„ âœ…
- [x] memU é›†æˆå®Œæˆ âœ…
- [x] é™çº§æœºåˆ¶å·¥ä½œæ­£å¸¸ âœ…

## ğŸš€ ä¸‹ä¸€æ­¥

é˜¶æ®µ 1 å·²å®Œæˆï¼Œå¯ä»¥å¼€å§‹é˜¶æ®µ 2ï¼š

**é˜¶æ®µ 2ï¼šå°è£… LangChain Memory å±‚**
- åˆ›å»º `chat_memory.py`
- ä¸ºæ¯ä¸ªç”¨æˆ·åˆ›å»ºç‹¬ç«‹çš„ LangChain Memory å®ä¾‹
- ä¸ memU å­˜å‚¨å±‚åŒæ­¥

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

```python
import asyncio
from memory_store import MemUStore
from profile_schema import init_profile

async def example():
    # åˆå§‹åŒ–å­˜å‚¨å±‚
    store = MemUStore(use_local_cache=True)
    
    # ä¿å­˜ç”»åƒ
    profile = init_profile()
    profile["demographics"]["age"]["value"] = 68
    await store.save_profile("user_001", profile)
    
    # åŠ è½½ç”»åƒ
    loaded_profile = await store.load_profile("user_001")
    
    # æ·»åŠ å¯¹è¯
    await store.append_message("user_001", "user", "ä½ å¥½")
    await store.append_message("user_001", "assistant", "æ‚¨å¥½ï¼")
    
    # åŠ è½½å¯¹è¯å†å²
    conversation = await store.load_conversation("user_001")
    
    # æ£€ç´¢è®°å¿†
    memory = await store.get_user_memory("user_001", "ç”¨æˆ·çš„å¹´é¾„")

asyncio.run(example())
```

---

**å®Œæˆæ—¶é—´**: 2026-01-22  
**çŠ¶æ€**: âœ… é˜¶æ®µ 1 å®Œæˆï¼Œå‡†å¤‡å¼€å§‹é˜¶æ®µ 2

